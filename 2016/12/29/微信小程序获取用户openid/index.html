<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>微信小程序获取用户openid | 绝知此事要躬行</title><link rel="stylesheet" type="text/css" href="//fonts.useso.com/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.0.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">微信小程序获取用户openid</h1><a id="logo" href="/.">绝知此事要躬行</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">微信小程序获取用户openid</h1><div class="post-meta">Dec 29, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>微信官方提供了两个不同的方法获取用户的信息，wx.login(OBJECT)和wx.getUserInfo(OBJECT）。getUserInfo获取用户信息，需要先调用 wx.login 接口。</p>
<p>如果只需要获取用户的基本信息，如性别昵称等，在小程序里面通过js就可以获取到。但是如果想要获取用户的openid和session_key就需要自己写一个服务端了。</p>
<p>网上有一个<a href="https://leancloud.cn" target="_blank" rel="external">leancloud</a>可以帮你实现“服务端”部分，但是作为技术宅怎么可以因为这么点小问题就把自己的AK和SK交给第三方呢？</p>
<p>于是就有了下文…..</p>
<p>微信小程序获取用户的openid分为两个步骤：<br>1.获取code<br>2.通过code获取用户的openid和session key</p>
<p>先说结论，以下是亲测可用的代码：</p>
<p><strong>客户端</strong></p>
<p>app.js(没错就是小程序里面初始化自带的app.js)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">//app.js</div><div class="line">App(&#123;</div><div class="line">  onLaunch: function () &#123;</div><div class="line">    //调用API从本地缓存中获取数据</div><div class="line">    var logs = wx.getStorageSync(&apos;logs&apos;) || []</div><div class="line">    logs.unshift(Date.now())</div><div class="line">    wx.setStorageSync(&apos;logs&apos;, logs)</div><div class="line"></div><div class="line">    wx.login(&#123;</div><div class="line">      success: function(res) &#123;</div><div class="line">        if (res.code) &#123;</div><div class="line">          //发起网络请求</div><div class="line">          wx.request(&#123;</div><div class="line">            url: &apos;http://myDomain/getSessionKey?code=&apos;+res.code,</div><div class="line">            header: &#123;</div><div class="line">                &apos;content-type&apos;: &apos;application/json&apos;</div><div class="line">            &#125;,</div><div class="line">            success: function(res) &#123;</div><div class="line">              //返回微信产生的openid和session_key</div><div class="line">              console.log(&quot;res.data=====&quot;+res.data)</div><div class="line">	    		wx.setStorageSync(&apos;userInfo&apos;, res.data)</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125; else &#123;</div><div class="line">          console.log(&apos;获取用户登录态失败！&apos; + res.errMsg)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  </div><div class="line"></div><div class="line">  &#125;,</div><div class="line">  getUserInfo:function(cb)&#123;</div><div class="line">    var that = this</div><div class="line">    if(this.globalData.userInfo)&#123;</div><div class="line">      typeof cb == &quot;function&quot; &amp;&amp; cb(this.globalData.userInfo)</div><div class="line">    &#125;else&#123;</div><div class="line">      //调用登录接口</div><div class="line">      wx.login(&#123;</div><div class="line">        success: function () &#123;</div><div class="line">          wx.getUserInfo(&#123;</div><div class="line">            success: function (res) &#123;</div><div class="line">              that.globalData.userInfo = res.userInfo</div><div class="line">              typeof cb == &quot;function&quot; &amp;&amp; cb(that.globalData.userInfo)</div><div class="line">            &#125;</div><div class="line">          &#125;)</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  globalData:&#123;</div><div class="line">    userInfo:null</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>服务端</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">@ResponseBody</div><div class="line">	@RequestMapping(&quot;/getSessionKey&quot;)</div><div class="line">	public com.alibaba.fastjson.JSONObject getSessionKey(HttpServletRequest req, HttpServletResponse resp) throws IOException &#123;</div><div class="line">		Map&lt;String, Object&gt; resMap = new HashMap&lt;String, Object&gt;();</div><div class="line">		String APP_ID = &quot;&quot;;</div><div class="line">		String APP_SECRET = &quot;&quot;;</div><div class="line">		String code = req.getParameter(&quot;code&quot;);</div><div class="line">		</div><div class="line">		String url = &quot;https://api.weixin.qq.com/sns/jscode2session?&quot;</div><div class="line">				+ &quot;appid=&quot;+APP_ID</div><div class="line">				+ &quot;&amp;secret=&quot;+APP_SECRET</div><div class="line">				+ &quot;&amp;js_code=&quot;+code</div><div class="line">				+ &quot;&amp;grant_type=authorization_code&quot;;</div><div class="line">		</div><div class="line">		Map&lt;String, Object&gt; result = httpGet(url);</div><div class="line">		</div><div class="line">		JSONObject json =JSON.parseObject(result.get(&quot;result&quot;).toString());</div><div class="line">		</div><div class="line">		String openId = json.get(&quot;openid&quot;).toString();</div><div class="line">		String session_key = json.get(&quot;session_key&quot;).toString();</div><div class="line">		</div><div class="line">		JSONObject reJson = new JSONObject();</div><div class="line">		reJson.put(&quot;openId&quot;, openId);</div><div class="line">		reJson.put(&quot;session_key&quot;, session_key);</div><div class="line">		return reJson;</div><div class="line">	&#125;</div><div class="line">	private static Map&lt;String,Object&gt; httpGet(String url) &#123;  </div><div class="line">    	Map&lt;String,Object&gt; resultMap = new HashMap&lt;String, Object&gt;();</div><div class="line">        org.apache.http.impl.client.CloseableHttpClient httpclient = HttpClients.createDefault();  </div><div class="line">        try &#123;  </div><div class="line">            org.apache.http.client.methods.HttpGet httpget = new HttpGet(url);  </div><div class="line">            org.apache.http.client.methods.CloseableHttpResponse response = httpclient.execute(httpget);  </div><div class="line">            try &#123;  </div><div class="line">                org.apache.http.HttpEntity entity = response.getEntity();  </div><div class="line">                String resStr = EntityUtils.toString(entity);</div><div class="line">                resultMap.put(&quot;result&quot;, resStr);</div><div class="line">                resultMap.put(&quot;status&quot;, response.getStatusLine());</div><div class="line">            &#125;catch (Exception e) &#123;</div><div class="line">            	e.printStackTrace();</div><div class="line">			&#125; finally &#123;  </div><div class="line">				response.close();  </div><div class="line">            &#125;  </div><div class="line">        &#125; catch (ClientProtocolException e) &#123;  </div><div class="line">            e.printStackTrace();  </div><div class="line">        &#125; catch (ParseException e) &#123;  </div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; catch (IOException e) &#123;  </div><div class="line">            e.printStackTrace();  </div><div class="line">        &#125; finally &#123;  </div><div class="line">            try &#123;  </div><div class="line">                httpclient.close();  </div><div class="line">            &#125; catch (IOException e) &#123;  </div><div class="line">                e.printStackTrace();  </div><div class="line">            &#125;  </div><div class="line">        &#125; </div><div class="line">        return resultMap;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><a href="https://mp.weixin.qq.com/debug/wxadoc/dev/api/api-login.html?t=20161222#wxloginobject" target="_blank" rel="external">https://mp.weixin.qq.com/debug/wxadoc/dev/api/api-login.html?t=20161222#wxloginobject</a></p>
<p>待续……..</p>
</div><div class="tags"><a href="/tags/互联网/">互联网</a></div><div class="post-nav"><a href="/2016/12/28/Hexo安装笔记/" class="next">Hexo安装笔记</a></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/互联网/" style="font-size: 15px;">互联网</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/29/微信小程序获取用户openid/">微信小程序获取用户openid</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/Hexo安装笔记/">Hexo安装笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:zhenggchaoo@gmail.com" target="_blank" class="fa fa-email"> </a><a href="http://weibo.com/zhengchaooo" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/chaooo" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">zhao Han</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=1.0.0"></script></body></html>